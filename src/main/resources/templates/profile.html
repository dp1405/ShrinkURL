<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{base :: layout(~{::title}, ~{::main})}">
<head>
    <title>Profile</title>
</head>
<body>
    <main>
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="profile-avatar mb-3">
                                <div class="avatar-circle">
                                    <i class="fas fa-user fa-3x text-primary"></i>
                                </div>
                            </div>
                            <h5 th:text="${user.firstName + ' ' + user.lastName}">John Doe</h5>
                            <p class="text-muted" th:text="${user.email}">john@example.com</p>
                            <span class="badge badge-success" th:text="${user.plan}">Free Plan</span>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="card-title">Account Statistics</h6>
                            <div class="stat-item d-flex justify-content-between">
                                <span>Total Links:</span>
                                <strong th:text="${userStats.totalLinks}">0</strong>
                            </div>
                            <div class="stat-item d-flex justify-content-between">
                                <span>Total Clicks:</span>
                                <strong th:text="${userStats.totalClicks}">0</strong>
                            </div>
                            <div class="stat-item d-flex justify-content-between">
                                <span>This Month:</span>
                                <strong th:text="${userStats.monthlyClicks}">0</strong>
                            </div>
                            <div class="stat-item d-flex justify-content-between">
                                <span>Member Since:</span>
                                <strong th:text="${#temporals.format(user.createdAt, 'MMM yyyy')}">Jan 2024</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="profile-tab" data-bs-toggle="tab" href="#profile" role="tab">
                                        <i class="fas fa-user"></i> Profile
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="links-tab" data-bs-toggle="tab" href="#links" role="tab">
                                        <i class="fas fa-link"></i> My Links
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings" role="tab">
                                        <i class="fas fa-cog"></i> Settings
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="card-body">
                            <div class="tab-content">
                                <!-- Profile Tab -->
                                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                                    <form th:action="@{/user/profile}" method="post" th:object="${user}">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="firstName" 
                                                           th:field="*{firstName}" placeholder="First Name" required>
                                                    <label for="firstName">First Name</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="lastName" 
                                                           th:field="*{lastName}" placeholder="Last Name" required>
                                                    <label for="lastName">Last Name</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-floating mb-3">
                                            <input type="email" class="form-control" id="email" 
                                                   th:field="*{email}" placeholder="name@example.com" required>
                                            <label for="email">Email address</label>
                                        </div>
                                        
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="company" 
                                                   th:field="*{company}" placeholder="Company">
                                            <label for="company">Company (Optional)</label>
                                        </div>
                                        
                                        <div class="form-floating mb-3">
                                            <textarea class="form-control" id="bio" th:field="*{bio}" 
                                                      placeholder="Bio" style="height: 100px"></textarea>
                                            <label for="bio">Bio (Optional)</label>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- Links Tab -->
                                <div class="tab-pane fade" id="links" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>My Links</h5>
                                        <a th:href="@{/}" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Create New Link
                                        </a>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Original URL</th>
                                                    <th>Short URL</th>
                                                    <th>Clicks</th>
                                                    <th>Created</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="link : ${userLinks}">
                                                    <td>
                                                        <div class="url-cell">
                                                            <span th:text="${#strings.abbreviate(link.originalUrl, 40)}">Original URL</span>
                                                            <small class="text-muted d-block" th:text="${link.originalUrl}">Full URL</small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <code th:text="${link.shortUrl}">shrink.url/abc123</code>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info" th:text="${link.clickCount}">0</span>
                                                    </td>
                                                    <td th:text="${#temporals.format(link.createdAt, 'MMM dd, yyyy')}">Jan 01, 2024</td>
                                                    <td>
                                                        <span class="badge" 
                                                              th:classappend="${link.active ? 'bg-success' : 'bg-secondary'}"
                                                              th:text="${link.active ? 'Active' : 'Inactive'}">Active</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                    th:onclick="'copyToClipboard(\'' + ${link.shortUrl} + '\')'">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                                    th:onclick="'showLinkStats(\'' + ${link.id} + '\')'">
                                                                <i class="fas fa-chart-bar"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                    th:onclick="'deleteLink(\'' + ${link.id} + '\')'">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Pagination -->
                                    <nav th:if="${totalPages > 1}">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                                <a class="page-link" th:href="@{/user/profile(page=${currentPage - 1})}">Previous</a>
                                            </li>
                                            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                                th:classappend="${i == currentPage ? 'active' : ''}">
                                                <a class="page-link" th:href="@{/user/profile(page=${i})}" th:text="${i + 1}">1</a>
                                            </li>
                                            <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                                <a class="page-link" th:href="@{/user/profile(page=${currentPage + 1})}">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                                
                                <!-- Settings Tab -->
                                <div class="tab-pane fade" id="settings" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Account Settings</h6>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="emailNotifications" 
                                                       th:checked="${user.emailNotifications}">
                                                <label class="form-check-label" for="emailNotifications">
                                                    Email Notifications
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="publicProfile" 
                                                       th:checked="${user.publicProfile}">
                                                <label class="form-check-label" for="publicProfile">
                                                    Public Profile
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="analyticsTracking" 
                                                       th:checked="${user.analyticsTracking}">
                                                <label class="form-check-label" for="analyticsTracking">
                                                    Analytics Tracking
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h6>Change Password</h6>
                                            <form th:action="@{/user/change-password}" method="post">
                                                <div class="form-floating mb-3">
                                                    <input type="password" class="form-control" id="currentPassword" 
                                                           name="currentPassword" placeholder="Current Password" required>
                                                    <label for="currentPassword">Current Password</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input type="password" class="form-control" id="newPassword" 
                                                           name="newPassword" placeholder="New Password" required>
                                                    <label for="newPassword">New Password</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input type="password" class="form-control" id="confirmNewPassword" 
                                                           name="confirmNewPassword" placeholder="Confirm New Password" required>
                                                    <label for="confirmNewPassword">Confirm New Password</label>
                                                </div>
                                                <button type="submit" class="btn btn-warning">
                                                    <i class="fas fa-key"></i> Change Password
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-danger">Danger Zone</h6>
                                            <p class="text-muted">
                                                These actions cannot be undone. Please be careful.
                                            </p>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                                <i class="fas fa-trash"></i> Delete Account
                                            </button>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h6>Data Export</h6>
                                            <p class="text-muted">
                                                Download all your data and links.
                                            </p>
                                            <a th:href="@{/user/export}" class="btn btn-outline-info">
                                                <i class="fas fa-download"></i> Export Data
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete Account Modal -->
        <div class="modal fade" id="deleteAccountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">Delete Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Are you sure you want to delete your account?</strong></p>
                        <p class="text-muted">
                            This action cannot be undone. This will permanently delete your account and remove all of your data from our servers.
                        </p>
                        <ul class="text-danger">
                            <li>All your shortened URLs will be deleted</li>
                            <li>All analytics data will be lost</li>
                            <li>Your account data will be permanently removed</li>
                        </ul>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="deleteConfirmation" 
                                   placeholder="Type 'DELETE' to confirm">
                            <label for="deleteConfirmation">Type 'DELETE' to confirm</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <th:block th:fragment="scripts">
        <script>
            // Tab persistence
            const activeTab = localStorage.getItem('activeTab');
            if (activeTab) {
                const tab = document.querySelector(`[href="${activeTab}"]`);
                if (tab) {
                    new bootstrap.Tab(tab).show();
                }
            }
            
            // Save active tab
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    localStorage.setItem('activeTab', e.target.getAttribute('href'));
                });
            });
            
            // Delete confirmation
            document.getElementById('deleteConfirmation').addEventListener('input', function() {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.disabled = this.value !== 'DELETE';
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                if (confirm('This action cannot be undone. Are you absolutely sure?')) {
                    window.location.href = '/user/delete-account';
                }
            });
            
            // Link management functions
            function copyToClipboard(url) {
                navigator.clipboard.writeText(url).then(() => {
                    ShrinkURL.showToast('URL copied to clipboard!', 'success');
                });
            }
            
            function showLinkStats(linkId) {
                // Implementation for showing link statistics
                URLShortener.showStats(linkId);
            }
            
            function deleteLink(linkId) {
                if (confirm('Are you sure you want to delete this link?')) {
                    fetch(`/api/links/${linkId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                                ShrinkURL.showToast('Link deleted successfully', 'success');
                            } else {
                                ShrinkURL.showToast('Failed to delete link', 'error');
                            }
                        });
                }
            }
            
            // Settings auto-save
            document.querySelectorAll('#settings input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const setting = this.id;
                    const value = this.checked;
                    
                    fetch('/api/user/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            setting: setting,
                            value: value
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            ShrinkURL.showToast('Setting updated', 'success');
                        } else {
                            ShrinkURL.showToast('Failed to update setting', 'error');
                            this.checked = !value; // Revert
                        }
                    });
                });
            });
        </script>
    </th:block>
</body>
</html>